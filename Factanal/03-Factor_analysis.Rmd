---
title: "Factor analysis"
author: "Anna Quaglieri & Riccardo Amorati"
date: "03/09/2017"
output:
  github_document:
    toc: yes
    toc_depth: 4
  html_document:
    toc: yes
    toc_depth: '4'
  html_notebook:
    code_folding: hide
    fig_caption: yes
    number_sections: yes
    toc: yes
    toc_float: yes
---

```{r,message=FALSE, echo=FALSE}
library(readr)
library(tidyverse)
library(reshape2)
library(corrplot)
library(psych)
library(pheatmap)
library(RColorBrewer)
library(cowplot)
library(gridExtra)
library(cowplot)
library(pheatmap)
library(sjPlot)
library(sjlabelled)
library(sjmisc)
library(knitr)

data(efc)
theme_set(theme_sjplot())

# Chunk options
knitr::opts_chunk$set(echo = TRUE, prompt = TRUE,cache = TRUE,fig.width = 12,fig.height = 12)

```

## Basic factor analysis: 7 factors as the number of variables in the study design

## Read in data

```{r}
all <- read.csv("../02-descriptive_data/merged_filtered_imputedMedian_likertNumber.csv")
rownames(all) <- all$Resp.ID
```

Seven, is the number of factors that would be present according to the study design.
Using very relaxed cutoff of 0.2 to get rid of not important variables in each factor.

### Likert variables

```{r include=FALSE,message=FALSE}
likert_grep <- "\\.id$|\\.ought$|\\.intr$|\\.instru$|\\.integr$|\\.prof$|\\.post$|\\.comm$|^necessity$|^educated$"

# all
likert_variables_all <- colnames(all)[grep(likert_grep,colnames(all))]
likert_variables_all
likert_variables_all <- likert_variables_all[!(likert_variables_all %in% "other.prof")]

# likert variables converted to numbers
likert_variables1 <- paste0(likert_variables_all,"1")

```


### Delete some items which are context specific

```{r}
# items to be used for the FA
usable_items <- likert_variables1[!(likert_variables1 %in% c("necessity1","educated1","reconnect.comm1", "speakersmelb.comm1", "comecloser.comm1"))]

usable_data <- all[,usable_items]
sum(is.na(usable_data))

# Cronbach's alpha using consistent items across contexts
psych::alpha(usable_data,use="pairwise.complete.obs")

fact <- 7
loading_cutoff <- 0.2
fa_basic <- fa(usable_data,fact)

fa_basic

# plot loadings
loadings_basic <- fa_basic$loadings
class(loadings_basic)<-"matrix"
colnames(loadings_basic)<-paste("F",1:fact,sep="")
loadings_basic<-as.data.frame(loadings_basic)
loadings_basic<-round(loadings_basic,2)
loadings_basic$D <- rownames(loadings_basic)
a1 <- loadings_basic

a1 <- melt(a1,id.vars=c("D"))
a1$inv <- ifelse(a1$value < 0 ,"neg","pos")
a1$value[abs(a1$value) < loading_cutoff] <- 0
a1 <- a1[a1$value!=0,]
a1 <- a1 %>% separate(D,into = c("Variable","Item"),remove=FALSE,sep="[.]")

ggplot(a1)+geom_bar(aes(x=reorder(D, value) ,y=value,fill=Item),stat="identity")+facet_wrap(~variable,ncol = 2,scales = "free_y")+coord_flip() + geom_hline(yintercept = c(-0.3,0.3),linetype="dotted",colour="dark red")

# Table of the factors
loadings_basic$D <- NULL
loadings_basic[abs(loadings_basic) < loading_cutoff] <- 0
for(i in 1:ncol(loadings_basic)){loadings_basic[,i] <- as.character(loadings_basic[,i])}

loadings_basic[loadings_basic=="0"] <- ""
loading_fact_reduced <- loadings_basic
loading_fact_reduced

# predict values per samples
pred_basic <- as.data.frame(predict(fa_basic,usable_data))
names(pred_basic) <- paste("Factor",1:fact,sep = "")

factors <- names(pred_basic)
match_initial_data <- match(all$Resp.ID,rownames(pred_basic))
all_complete_basic <- cbind(all,scale(pred_basic[match_initial_data,]))
corrplot(cor(all_complete_basic[,usable_items],all_complete_basic[,factors],use = "pair"))

# Plot loadings by context
all_complete_basic <- melt(all_complete_basic,id.vars = "Context",measure.vars = factors)

library(ggplot2)
ggplot(all_complete_basic)+geom_boxplot(aes(x=Context,y=value,color=Context))+facet_wrap(~variable)+coord_flip()+guides(color=F)
# 7 * 12 rows removed

```

## Basic factor analysis: 6 factors

Using very relaxed cutoff of 0.2 to get rid of not important variables in each factor.

```{r}
# items to be used for the FA
usable_items <- likert_variables1[!(likert_variables1 %in% c("necessity1","educated1","reconnect.comm1", "speakersmelb.comm1", "comecloser.comm1"))]

usable_data <- all[,usable_items]

# From a statisticak point of view 
fap <- fa.parallel(usable_data)
fact <- 6
loading_cutoff <- 0.2
fa_basic <- fa(usable_data,fact)

fa_basic

# plot loadings
loadings_basic <- fa_basic$loadings
class(loadings_basic)<-"matrix"
colnames(loadings_basic)<-paste("F",1:fact,sep="")
loadings_basic<-as.data.frame(loadings_basic)
loadings_basic<-round(loadings_basic,2)
loadings_basic$D <- rownames(loadings_basic)
a1 <- loadings_basic

a1 <- melt(a1,id.vars=c("D"))
a1$inv <- ifelse(a1$value < 0 ,"neg","pos")
a1$value[abs(a1$value) < loading_cutoff] <- 0
a1 <- a1[a1$value!=0,]
a1 <- a1 %>% separate(D,into = c("Variable","Item"),remove=FALSE,sep="[.]")

ggplot(a1)+geom_bar(aes(x=reorder(D, value) ,y=value,fill=Item),stat="identity")+facet_wrap(~variable,ncol = 2,scales = "free_y")+coord_flip() + geom_hline(yintercept = c(-0.3,0.3),linetype="dotted",colour="dark red")

# Table of the factors
loadings_basic$D <- NULL
loadings_basic[abs(loadings_basic) < loading_cutoff] <- 0
for(i in 1:ncol(loadings_basic)){loadings_basic[,i] <- as.character(loadings_basic[,i])}

loadings_basic[loadings_basic=="0"] <- ""
loading_fact_reduced <- loadings_basic
loading_fact_reduced

# predict values per samples
pred_basic <- as.data.frame(predict(fa_basic,usable_data))
names(pred_basic) <- paste("Factor",1:fact,sep = "")

factors <- names(pred_basic)
match_initial_data <- match(all$Resp.ID,rownames(pred_basic))
all_complete_basic <- cbind(all,scale(pred_basic[match_initial_data,]))
corrplot(cor(all_complete_basic[,usable_items],all_complete_basic[,factors],use = "pair"))

# Plot loadings by context
all_complete_basic <- melt(all_complete_basic,id.vars = "Context",measure.vars = factors)

library(ggplot2)
ggplot(all_complete_basic)+geom_boxplot(aes(x=Context,y=value,color=Context))+facet_wrap(~variable)+coord_flip()+guides(color=F)
# 7 * 12 rows removed

# error bar 
sum_stat <- all_complete_basic %>% group_by(Context,variable) %>%
  summarise(meanFac = mean(value,na.rm=TRUE),
            stdFac = sd(value,na.rm=TRUE),
            nObs = length(Context[!is.na(value)])) %>%
  mutate(seMean = stdFac/sqrt(nObs),
         CI95 = 1.96*seMean)

ggplot(sum_stat,aes(x=Context,y=meanFac,colour=Context)) + 
geom_errorbar(aes(ymin=meanFac-CI95, ymax=meanFac+CI95),width=0.2) + facet_wrap(~variable,scales="free_y") + geom_point() +theme(axis.text.x = element_text(angle = 45, hjust = 1))+ ggtitle("Mean +- 95% CI")

ggplot(sum_stat,aes(x=variable,y=meanFac,colour=variable)) + 
geom_errorbar(aes(ymin=meanFac-CI95, ymax=meanFac+CI95),width=0.2) + facet_wrap(~Context,scales="free_y") + 
  geom_point() + ggtitle("Mean +- 95% CI")

kable(sum_stat)
```

## Factor analysis correcting for context

```{r}
# items to be used for the FA
usable_items <- likert_variables1[!(likert_variables1 %in% c("necessity1","educated1","reconnect.comm1", "speakersmelb.comm1", "comecloser.comm1"))]

usable_data <- all[,c(usable_items,"Context")]
dat_onlyItems <- usable_data[,usable_items]

# get residuals after regressing for context
get_residuals <- function(item,pred = dat$Context){
  mod <- lm(item ~ pred)
  return(mod$residuals)
}


applygetRes <- apply(as.matrix(dat_onlyItems),2,get_residuals,
                     pred=usable_data$Context)

# Factanal 
# From a statisticak point of view 
fap <- fa.parallel(applygetRes)
fact <- 6
loading_cutoff <- 0.2
fa_basic <- fa(applygetRes,fact)

fa_basic

# plot loadings
loadings_basic <- fa_basic$loadings
class(loadings_basic)<-"matrix"
colnames(loadings_basic)<-paste("F",1:fact,sep="")
loadings_basic<-as.data.frame(loadings_basic)
loadings_basic<-round(loadings_basic,2)
loadings_basic$D <- rownames(loadings_basic)
a1 <- loadings_basic

a1 <- melt(a1,id.vars=c("D"))
a1$inv <- ifelse(a1$value < 0 ,"neg","pos")
a1$value[abs(a1$value) < loading_cutoff] <- 0
a1 <- a1[a1$value!=0,]
a1 <- a1 %>% separate(D,into = c("Variable","Item"),remove=FALSE,sep="[.]")

ggplot(a1)+geom_bar(aes(x=reorder(D, value) ,y=value,fill=Item),stat="identity")+facet_wrap(~variable,ncol = 2,scales = "free_y")+coord_flip() + geom_hline(yintercept = c(-0.3,0.3),linetype="dotted",colour="dark red")

# Table of the factors
loadings_basic$D <- NULL
loadings_basic[abs(loadings_basic) < loading_cutoff] <- 0
for(i in 1:ncol(loadings_basic)){loadings_basic[,i] <- as.character(loadings_basic[,i])}

loadings_basic[loadings_basic=="0"] <- ""
loading_fact_reduced <- loadings_basic
loading_fact_reduced

# predict values per samples
pred_basic <- as.data.frame(predict(fa_basic,dat_onlyItems))
names(pred_basic) <- paste("Factor",1:fact,sep = "")

factors <- names(pred_basic)
match_initial_data <- match(all$Resp.ID,rownames(pred_basic))
all_complete_basic <- cbind(all,scale(pred_basic[match_initial_data,]))
corrplot(cor(all_complete_basic[,usable_items],all_complete_basic[,factors],use = "pair"))

# Plot loadings by context
all_complete_melt <- melt(all_complete_basic,id.vars = "Context",measure.vars = factors)

library(ggplot2)
ggplot(all_complete_melt)+geom_boxplot(aes(x=Context,y=value,color=Context))+facet_wrap(~variable)+coord_flip()+guides(color=F)

# error bar 
sum_stat <- all_complete_melt %>% group_by(Context,variable) %>%
  summarise(meanFac = mean(value,na.rm=TRUE),
            stdFac = sd(value,na.rm=TRUE),
            nObs = length(Context[!is.na(value)])) %>%
  mutate(seMean = stdFac/sqrt(nObs),
         CI95 = 1.96*seMean)

ggplot(sum_stat,aes(x=Context,y=meanFac,colour=Context)) + 
geom_errorbar(aes(ymin=meanFac-CI95, ymax=meanFac+CI95),width=0.2) + facet_wrap(~variable,scales="free_y") + geom_point() +theme(axis.text.x = element_text(angle = 45, hjust = 1))+ ggtitle("Mean +- 95% CI")

ggplot(sum_stat,aes(x=variable,y=meanFac,colour=variable)) + 
geom_errorbar(aes(ymin=meanFac-CI95, ymax=meanFac+CI95),width=0.2) + facet_wrap(~Context,scales="free_y") + 
  geom_point() + ggtitle("Mean +- 95% CI")

kable(sum_stat)
```

## Demographics

```{r}
demographics_var <- c("Age","Gender","L1","speak.other.L2","study.other.L2","origins","year.studyL2","other5.other.ways","degree","roleL2.degree","study.year","prof","L2.VCE","uni1.year","Context")

dat_fac_demo <- all_complete_basic[,c(demographics_var,factors)]
table(dat_fac_demo$Age) 
table(dat_fac_demo$L1) # to be changed
table(dat_fac_demo$speak.other.L2) # to be changed
table(dat_fac_demo$study.other.L2) # to be changed
table(dat_fac_demo$origins)
table(dat_fac_demo$year.studyL2) # to be changed
table(dat_fac_demo$other5.other.ways) # to be changed
table(dat_fac_demo$degree) # to be changed
table(dat_fac_demo$roleL2.degree) # not usable
table(dat_fac_demo$study.year)
table(dat_fac_demo$prof)
table(dat_fac_demo$L2.VCE)
table(dat_fac_demo$uni1.year) # not usable
```

```{r}
demo_melt <- melt(all_complete_basic,id.vars = c("Age","Gender","origins","study.year","prof","L2.VCE","Context"),measure.vars = factors)

# age
ageStat <- demo_melt %>% group_by(Context,Age,variable) %>%
  summarise(meanFac = mean(value,na.rm=TRUE),
            stdFac = sd(value,na.rm=TRUE),
            nObs = length(Age[!is.na(value)])) %>%
  mutate(seMean = stdFac/sqrt(nObs),
         CI95 = 1.96*seMean)

ageStat$Demo <- "Age"
colnames(ageStat)[2] <- "levels"
ageStat <- data.frame(ageStat)

# Gender
GenderStat <- demo_melt %>% group_by(Context,Gender,variable) %>%
  summarise(meanFac = mean(value,na.rm=TRUE),
            stdFac = sd(value,na.rm=TRUE),
            nObs = length(Gender[!is.na(value)])) %>%
  mutate(seMean = stdFac/sqrt(nObs),
         CI95 = 1.96*seMean)

GenderStat$Demo <- "Gender"
colnames(GenderStat)[2] <- "levels"
GenderStat <- data.frame(GenderStat)

# origins
originsStat <- demo_melt %>% group_by(Context,origins,variable) %>%
  summarise(meanFac = mean(value,na.rm=TRUE),
            stdFac = sd(value,na.rm=TRUE),
            nObs = length(origins[!is.na(value)])) %>%
  mutate(seMean = stdFac/sqrt(nObs),
         CI95 = 1.96*seMean)

originsStat$Demo <- "origins"
colnames(originsStat)[2] <- "levels"
originsStat <- data.frame(originsStat)

# study.year
study.yearStat <- demo_melt %>% group_by(Context,study.year,variable) %>%
  summarise(meanFac = mean(value,na.rm=TRUE),
            stdFac = sd(value,na.rm=TRUE),
            nObs = length(study.year[!is.na(value)])) %>%
  mutate(seMean = stdFac/sqrt(nObs),
         CI95 = 1.96*seMean)

study.yearStat$Demo <- "Study Year"
colnames(study.yearStat)[2] <- "levels"
study.yearStat <- data.frame(study.yearStat)

# prof
profStat <- demo_melt %>% group_by(Context,prof,variable) %>%
  summarise(meanFac = mean(value,na.rm=TRUE),
            stdFac = sd(value,na.rm=TRUE),
            nObs = length(prof[!is.na(value)])) %>%
  mutate(seMean = stdFac/sqrt(nObs),
         CI95 = 1.96*seMean)

profStat$Demo <- "Proficiency"
colnames(profStat)[2] <- "levels"
profStat$levels <- as.character(profStat$levels)
profStat <- data.frame(profStat)

# L2.VCE
L2.VCEStat <- demo_melt %>% group_by(Context,L2.VCE,variable) %>%
  summarise(meanFac = mean(value,na.rm=TRUE),
            stdFac = sd(value,na.rm=TRUE),
            nObs = length(L2.VCE[!is.na(value)])) %>%
  mutate(seMean = stdFac/sqrt(nObs),
         CI95 = 1.96*seMean)

L2.VCEStat$Demo <- "L2.VCE"
colnames(L2.VCEStat)[2] <- "levels"
L2.VCEStat$levels <- as.character(L2.VCEStat$levels)
L2.VCEStat <- data.frame(L2.VCEStat)

##################
# Combine stats
##################

combine_stat <- rbind(data.frame(L2.VCEStat),data.frame(profStat),study.yearStat,originsStat,ageStat,GenderStat)
```

### Tables

- **Age**

```{r}
kable(ageStat)
```

- **Gender**

```{r}
kable(GenderStat)
```

- **origins**

```{r}
kable(originsStat)
```

- **study.year**

```{r}
kable(study.yearStat)
```

- **prof**

```{r}
kable(profStat)
```

- **L2.VCE**

```{r}
kable(L2.VCEStat)
```

### Factor means with Confidence Intervals

```{r}
pos <- position_dodge(width=0.4)
ggplot(subset(combine_stat,variable %in% c("Factor1")),aes(x=levels,y=meanFac,colour=Context,group=Context)) + 
geom_errorbar(aes(ymin=meanFac-CI95, ymax=meanFac+CI95),width=0.2,position=pos) + facet_wrap(~Demo ,scales="free") +
  geom_point(position=pos) + ggtitle("Factor1: Mean +- 95% CI") + theme_bw()

pos <- position_dodge(width=0.4)
ggplot(subset(combine_stat,variable %in% c("Factor2")),aes(x=levels,y=meanFac,colour=Context,group=Context)) + 
geom_errorbar(aes(ymin=meanFac-CI95, ymax=meanFac+CI95),width=0.2,position=pos) + facet_wrap(~Demo ,scales="free") +
  geom_point(position=pos) + ggtitle("Factor2: Mean +- 95% CI") + theme_bw()

pos <- position_dodge(width=0.4)
ggplot(subset(combine_stat,variable %in% c("Factor3")),aes(x=levels,y=meanFac,colour=Context,group=Context)) + 
geom_errorbar(aes(ymin=meanFac-CI95, ymax=meanFac+CI95),width=0.2,position=pos) + facet_wrap(~Demo ,scales="free") +
  geom_point(position=pos) + ggtitle("Factor3: Mean +- 95% CI") + theme_bw()

pos <- position_dodge(width=0.4)
ggplot(subset(combine_stat,variable %in% c("Factor4")),aes(x=levels,y=meanFac,colour=Context,group=Context)) + 
geom_errorbar(aes(ymin=meanFac-CI95, ymax=meanFac+CI95),width=0.2,position=pos) + facet_wrap(~Demo ,scales="free") +
  geom_point(position=pos) + ggtitle("Factor4: Mean +- 95% CI") + theme_bw()


pos <- position_dodge(width=0.4)
ggplot(subset(combine_stat,variable %in% c("Factor5")),aes(x=levels,y=meanFac,colour=Context,group=Context)) + 
geom_errorbar(aes(ymin=meanFac-CI95, ymax=meanFac+CI95),width=0.2,position=pos) + facet_wrap(~Demo ,scales="free") +
  geom_point(position=pos) + ggtitle("Factor5: Mean +- 95% CI") + theme_bw()

pos <- position_dodge(width=0.4)
ggplot(subset(combine_stat,variable %in% c("Factor6")),aes(x=levels,y=meanFac,colour=Context,group=Context)) + 
geom_errorbar(aes(ymin=meanFac-CI95, ymax=meanFac+CI95),width=0.2,position=pos) + facet_wrap(~Demo ,scales="free") +
  geom_point(position=pos) + ggtitle("Factor6: Mean +- 95% CI") + theme_bw()
```

